name: Build macOS Fast

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Auto cancel build lama kalau ada push baru
concurrency:
  group: macos-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-12

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # Cache JUCE source
    - name: Cache JUCE
      uses: actions/cache@v3
      with:
        path: JUCE
        key: juce-7.0.10

    # Clone JUCE kalau belum ada
    - name: Setup JUCE
      run: |
        if [ ! -d "JUCE" ]; then
          git clone https://github.com/juce-framework/JUCE.git
          cd JUCE
          git checkout 7.0.10
        fi

    # Cache Projucer build
    - name: Cache Projucer
      uses: actions/cache@v3
      with:
        path: JUCE/extras/Projucer/Builds/MacOSX/build
        key: projucer-build

    # Build Projucer (kalau belum ada)
    - name: Build Projucer
      run: |
        PROJ=JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer

        if [ ! -f "$PROJ" ]; then
          cd JUCE/extras/Projucer/Builds/MacOSX
          xcodebuild -configuration Release
        fi

    # Generate Project
    - name: Generate Project
      run: |
        JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer \
          --resave "SORA_Matrix.jucer"

    # Build Universal Binary (Intel + ARM sekaligus)
    - name: Build Universal Binary
      run: |
        cd Builds/MacOSX

        xcodebuild \
          -configuration Release \
          -arch x86_64 \
          -arch arm64 \
          ONLY_ACTIVE_ARCH=NO

    # Package
    - name: Create ZIP
      run: |
        cd Builds/MacOSX/build/Release

        zip -r ../../../../SORA_Matrix-mac-universal.zip SORA_Matrix.app

    # Upload Artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SORA-Matrix-macOS
        path: SORA_Matrix-mac-universal.zip
